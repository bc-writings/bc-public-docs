% Source.
%     + https://tex.stackexchange.com/a/655445/6880
%     + https://tex.stackexchange.com/a/730033/6880

\usepackage{ifthen} % Pour des tests du type SI-SINON-SI.

\usepackage{tikz}
\usetikzlibrary{tikzmark}

%%%
% Un unique réglage "utilisateur".
%%%
\newlength{\nubunitht}
\setlength{\nubunitht}{.8ex}

%%%
% Notre macro interne.
%
% Arg. #1 : l'étiquette pour une série de décorations.
% Arg. #2 : la distance d'où partent les décalages verticaux.
% Arg. #3 : un décalage vertical.
% Arg. #4 : le contenu à décorer.
%%%
\newcommand{\internal@nub}[4]{%
%
  \tikzmark{nubstart#1#3}%
    #4%
  \tikzmark{nubend#1#3}%
%
  \pgfmathsetmacro\nubvoffset{#3 - #2}
%
  \llap{%
    \begin{tikzpicture}[
        remember picture,
        baseline = (current bounding box.north)
    ]
      \draw (pic cs:nubstart#1#3)
              --++ (0,\nubvoffset*\nubunitht)
              -|
            (pic cs:nubend#1#3);
    \end{tikzpicture}%
  }%
}

%%%
% Nos variables globales internes.
%%%

\newcommand{\nub@label}{}
\newcounter{nub@label@cnter}
\setcounter{nub@label@cnter}{0}

\newcounter{nub@depth@calls}
\setcounter{nub@depth@calls}{0}

\newcounter{nub@depth@draw}
\setcounter{nub@depth@draw}{0}

%%%
% Arg. #1 : le contenu à décorer.
%%%
\newcommand{\nub}[1]{%
%
  \ifthenelse{\arabic{nub@depth@calls} = 0}{
    \renewcommand{\nub@label}{nub@label@\alph{nub@label@cnter}}
    \addtocounter{nub@label@cnter}{1}
%
    \@ifundefined{nub@depth@\alph{nub@label@cnter}}{%
      \expandafter\gdef\csname nub@depth@\alph{nub@label@cnter}\endcsname{0}%
    }{}
  }{}%
%
  \addtocounter{nub@depth@calls}{1}%
  \ifthenelse{\arabic{nub@depth@calls} > \arabic{nub@depth@draw}}{
    \setcounter{nub@depth@draw}{\arabic{nub@depth@calls}}
  }{}%
%
  \internal@nub{\nub@label}              % Étiquette.
               {\csname nub@depth@\alph{nub@label@cnter}\endcsname}%
                                         % Départ des décalages.
               {\arabic{nub@depth@calls}}% Le décalage vertical.
               {#1}                      % Le contenu.
  \addtocounter{nub@depth@calls}{-1}%
%
  \ifthenelse{\arabic{nub@depth@calls} = 0}{
%
    \addtocounter{nub@depth@draw}{1}
%
    \immediate\write\@auxout{%
      \string\gdef\string%
        \nub@depth@\alph{nub@label@cnter}%
                 {\arabic{nub@depth@draw}}%%
    }
%
    \setcounter{nub@depth@draw}{0}
  }{}
}
