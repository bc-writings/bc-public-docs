% !TEX TS-program = lualatex

%%%
% src::
%   url = https: /  / github.com / pfradin / luadraw / discussions / 111#discussioncomment-14592216
%%%

\documentclass{standalone}

%%%
% Des couleurs nommées faciles d'emploi via le package ''xcolor''!
%%%
\usepackage[svgnames]{xcolor}

%%%
% La bibliothèque ''luadraw'' allie une facilité d’utilisation à
% un rendu particulièrement soigné.
%%%
\usepackage[3d]{luadraw}

%%%
% La bibliothèque ''shadings'' propre à \tikz nous permet d'avoir
% facilement des dégradés colorés.
%%%
\usetikzlibrary{shadings}

\begin{document}

\begin{luadraw}{name = so-cute-vector-field}
require 'luadraw_palettes'

------
-- ¨Def du ¨chp.
------
local f = function(x, y)
  return x^2 + y^2 - 1
end

local A_0 = Z(0, 1 / 2)

------
-- Réglages liés au tracé.
------
local xmin, xmax, ymin, ymax = -3, 3, -3, 3

local nb_divs = 20

local pal = getPal["palJet"]

------
-- ¨Def de la zone graphique.
------
local graphview = graph:new{
  window = {xmin - 0.5, xmax + 0.5, ymin - 0.5, ymax + 0.5},
  bg   = "",
  size   = {10, 10}
}

------
-- Construction du champ de ¨vects.
------
local delta_X = (xmax - xmin) / nb_divs
local delta_Y = (ymax - ymin) / nb_divs

local vectors = {}
local values  = {}
local x, y, img, v

local vect_norm = math.min(delta_X, delta_Y) - 0.1

local key

local img_min = math.huge
local img_max = - math.huge

for i = 0, nb_divs do
  local x    = xmin + delta_X * i
  local xmin = x + delta_X / 2

  for j = 0, nb_divs do
    local y    = ymin + delta_X * j
    local ymin = y + delta_Y / 2

    key = i .. " / " .. j
    img = f(x, y)

    if img < img_min then
      img_min = img
    end

    if img > img_max then
      img_max = img
    end

    values[key] = img

    if (i < nb_divs) and (j < nb_divs) then
      v = Z(1, f(xmin, ymin))
      v = v / cpx.abs(v) * vect_norm

      table.insert(vectors, {Z(xmin, ymin), Z(xmin, ymin) + v} )
    end
  end
end

------
-- Construction de la "¨surf de niveau".
------
local left_colors  = {}
local right_colors = {}
local color

for j = 0, nb_divs do
  key = "0 / " .. j

  color = mixcolor(
    palette(pal, (values[key] - img_min) / (img_max - img_min), true),
    0.75,
    White,
    0.25
  )

  table.insert(right_colors, color)
end

local eps =  1e-2

for i = 0, nb_divs-1 do
  local x = xmin + delta_X * i

  left_colors  = right_colors
  right_colors = {}

  for j = 0, nb_divs do
    key = (i + 1) .. " / " .. j

    color = mixcolor(
      palette(pal, (values[key] - img_min) / (img_max-img_min), true),
      0.75,
      White,
      0.25
    )

    table.insert(right_colors, color)
  end

  for j = 0, nb_divs - 1 do
    local y = ymin + delta_X * j

    local color0 = left_colors[j + 1]
    local color1 = right_colors[j + 1]
    local color2 = right_colors[j + 2]
    local color3 = left_colors[j + 2]

    local options = "upper left="..color3..", upper right="..color2..", lower left="..color0..", lower right="..color1

    graphview:Dpolyline(
      {
        Z(x-eps, y-eps),
        Z(x + delta_X + eps, y-eps),
        Z(x + delta_X + eps, y + delta_Y + eps),
        Z(x-eps, y + delta_Y + eps)
      },
      "draw = none, fill opacity = .65, " .. options
    )
  end
end

------
-- Ajout d'un cadre gradué.
------
graphview:Dgradbox(
  {
    Z(xmin, ymin), Z(xmax, ymax),
    1, 1
  },
  {
    originloc = 0,
    originnum = {0, 0},
    nbsubdiv  = {3, 3}
  }
)

------
-- Tracé des vecteurs.
------
graphview:Dpolyline(vectors, "-latex, darkgray")

------
-- ¨luadraw va résoudre et tracer la ¨sol de l'¨eq_diff.
------
graphview:Dodesolve(
  f,
  A_0.re, A_0.im,
  {
    t            = {xmin, xmax},
    clip         = {-2.5, 2.25, ymin, ymax},
    nbdots       = 150,
    draw_options = "Navy, line width = 1pt"
  }
)

------
-- Ajout du point initial.
------
graphview:Dlabeldot(
  "{\\boldmath $A_0$}", A_0, {pos = "S", node_options = "Navy"}
)

------
-- Montrons le résultat de notre oeuvre.
------
graphview:Show()
\end{luadraw}

\end{document}
