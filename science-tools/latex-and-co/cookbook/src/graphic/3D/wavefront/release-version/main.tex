% !TEX TS-program = lualatex

%%%
% src::
%     urls = https://github.com/pfradin/luadraw/discussions/64 ,
%            https://people.sc.fsu.edu/~jburkardt/data/obj/obj.html ,
%            https://dmccooey.com/polyhedra
%%%

\documentclass{standalone}

\usepackage{xcolor}

\usepackage[3d]{luadraw}

\begin{document}

\begin{luacode}
function update_extreme_vals(a, a_min, a_max)
  return math.min(a, a_min), math.max(a, a_max)
end

function parse_obj(file)
  local polyedron = {}
  local vertices  = {}
  local facets    = {}

  local xmin, xmax = math.huge, -math.huge
  local ymin, ymax = math.huge, -math.huge

-- Dans les ¨regexs ¨lua, ''%'' est le caractère d'échappement.
  for line in io.lines(file) do
-- Nettoyage des espaces finaux et initiaux : en ¨lua, ''-''
-- est un caractère spécial pour une recherche non gourmande.
    line = line:match("^%s*(.-)%s*$")

-- On ignore les lignes vides et les commentaires.
    if line ~= "" and not line:match("^#") then
-- Cas d'un sommet.
      if line:match("^v%s") then
-- La ¨regex suivante est fragile, mais nous faisons confiance
-- aux fichiers ext::''obj'' utilisés.
        local x, y, z = line:match(
          "^v%s+([%-%d%.]+)%s+([%-%d%.]+)%s+([%-%d%.]+)"
        )

        if x and y and z then
          x, y, z = tonumber(x), tonumber(y), tonumber(z)

-- Gestion des valeurs extrèmales.
          xmin, xmax = update_extreme_vals(x, xmin, xmax)
          ymin, ymax = update_extreme_vals(y, ymin, ymax)

-- Un nouveau sommet.
          table.insert(vertices, M(x, y, z))
        end

-- Cas d'une face.
      elseif line:match("^f%s") then
        local face = {}

        for idx in line:gmatch("(%d+)") do
          table.insert(face, tonumber(idx))
        end

        if #face > 0 then
          table.insert(facets, face)
        end
      end
    end
  end

  polyedron.vertices = vertices
  polyedron.facets   = facets

  return {xmin*1.2, xmax*1.2, ymin*1.2, ymax*1.2}, polyedron
end
\end{luacode}


\begin{luadraw}{name = 3D-model-obj-file}
------
-- Analyse d'un modèle 3D au format Wavefront.
------
-- local file = "icosahedron.obj"
-- local file = "truncated_icosahedron.obj"
local file = "teapot.obj"

local window_def, polyedron = parse_obj(file)

-- Un réglage manuel s'impose pour la théière!
window_def[3] = window_def[3] - 5

------
-- Définition de la zone graphique.
------
local graphview = graph3d:new{
  window  = window_def,
  viewdir = {-110, -20},
  size    = {10, 10}
}

------
-- Réglages liés aux lignes.
------
graphview:Linejoin("round")

Hiddenlines     = true
Hiddenlinestyle = "dashed"

------
-- Tracé du modèle.
------
graphview:Dpoly(
  polyedron,
  {
    mode  = 4,
    color = "cyan"
  })

------
-- Et le merveilleux se révèle au monde.
------
graphview:Show()
\end{luadraw}

\end{document}
