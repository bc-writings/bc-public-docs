% !TEX TS-program = lualatex

%%%
% src::
%     url = https://github.com/pfradin/luadraw/discussions/148#discussioncomment-14976053
%%%

\documentclass[border = 3pt]{standalone}

%%%
% Des couleurs faciles d'emploi via le package ''xcolor''!
%%%
\usepackage[svgnames]{xcolor}

%%%
% La biblioth√®que ''luadraw'' allie une facilit√© d‚Äôutilisation
% √† un rendu particuli√®rement soign√©.
%%%
\usepackage[3d]{luadraw}

\begin{document}

\begin{luadraw}{name = central-proj-of-sphere}
------
-- Nos ¬®elts de base.
------
local r      = 2
local center = M(-1, -1, 0)

local z0    = -3
local light = M(-5, -5, 5)

local proj = function(A)
  return proj3dO(
    A,
    {z0*vecK, vecK},
    A - light)
end

------
-- ¬®Def de la zone graphique.
------
local graphview = graph3d:new{
  window3d = {-5, 8, -5, 8, -3, 5},
  adjust2d = true,
  bbox     = false,
  viewdir  = {30, 60},
  size     = {10, 10}
}

------
-- R√©glages li√©s aux lignes.
------
graphview:Linewidth(6)
Hiddenlinestyle = "dashed"
Hiddenlines     = true

------
-- Une sph√®re, un faisceau et une ombre.
------
local S = {center, r}





------
-- Calcul du cercle de tangence de la sph√®re et du c√¥ne de lumi√®re.
------
local I = (light + center) / 2
local R = pt3d.abs(center - light) / 2

--- La fonction interSS(S1,S2) calcule et renvoie (si elle existe) l‚Äôintersection entre la sph√®re S1 = {C1,ùëü1} et S2 = {C2,ùëü2}. La fonction renvoie soit nil (intersection vide), ou bien une s√©quence de la forme I,ùëü,ùëõ, o√π centre, rayon normal au cercle
local J, r1, n = interSS(S, {I, R} )

-- Lafonctioncircle3d(I,R,normal)renvoielalistedespointsdececercle(lignepolygonale3d).
-- Lafonctioncircle3db(I,R,normal)renvoiececerclesousformed‚Äôunchemin3d(voirDpath3d)utilisantdescourbesde B√©zier.
local shadow = ftransform3d(
  circle3d(J, r1, n)[1],
  proj
)





------
-- Construction du faisceau comme cons√©quence de la source
-- lumineuse et de l'ombre...
------
local beam = pyramid(shadow, light, true)

------
-- Il ne reste plus qu'√† dessiner.
------
graphview:Dboxaxes3d({
  grid      = true,
  gridcolor = "gray",
  fillcolor = "lightgray!40"
})

graphview:Dballdots3d(light, "Yellow", 5)

graphview:Dsphere(
  center, r,
  {
    color = "Cyan",
    mode  = mBorder
  }
)

graphview:Dpolyline3d(
  shadow,
  true,
  "draw = none, fill = DarkGray, fill opacity = 0.9"
)

graphview:Dpoly(
  beam,
  {
    color    = "yellow",
    opacity  = 0.3,
    contrast = 0.5,
    mode     = mShadedOnly
  }
)

------
-- Montrons le r√©sultat de notre oeuvre.
------
graphview:Show()
\end{luadraw}

\end{document}
