% !TEX TS-program = lualatex

%%%
% src::
%     url = https://github.com/pfradin/luadraw/discussions/102#discussioncomment-14519914
%%%

\documentclass[border = 3pt]{standalone}

%%%
% Des couleurs faciles d'emploi via le package ''xcolor''!
%%%
\usepackage[svgnames]{xcolor}

%%%
% La bibliothèque ''luadraw'' allie une facilité d’utilisation à
% un rendu particulièrement soigné.
%%%
\usepackage[3d]{luadraw}

\begin{document}

\begin{luadraw}{name = half-cylinder}
------
-- ¨Def de la zone graphique.
------
local graphview = graph3d:new{
  size    = {10, 10},
  viewdir = {70, 60},
  bbox    = false
}

------
-- Réglages liés aux lignes.
------
Hiddenlines     = true
Hiddenlinestyle = "dashed"

------
-- prototype::
--     A : centre d'une base du cylindre sous-jacent.
--     r : rayon du cylindre sous-jacent.
--     B : centre de l'autre base du cylindre sous-jacent.
--     n : un vecteur normal à `line(A,B)`.
--
--     :action: création du demi-cylindre ouvert obtenu en coupant
--              le cylindre sous-jacent suivant le plan "orienté"
--              ``{A, n}``.
------
function graph3d:addHalfCyl(A, r, B, n, options)
  local cyl  = cylinder(A, r, B, 150)
  local P, w = {A, n}, B - A

  cyl = cutpoly(cyl, P)

  local L = self:Outline(cyl)
  L = concat(L.visible, L.hidden)

  n = r * pt3d.normalize(n)

  local B1, B2 = rotate3d(B + n, -90, {B, w})
  local B2     = 2*B - B1
  local A1, A2 = B1 - w, B2 - w

  local ret = {}

  insert(
    ret,
    self:addPoly(cyl, options)
  )

  insert(
    ret,
    self:addPolyline(
      L,
      {
        color = options.edgecolor,
        width = options.edgewidth
      }
    )
  )

  insert(
    ret,
    graphview:addArc(B1, B, B2, r, 1, w)
  )

  insert(
    ret,
    graphview:addArc(A1, A, A2, r, 1, w)
  )

  return ret
end

------
-- Tracé de deux demi-cylindres.
------
local r, h = 3, 4

graphview:Dscene3d(
-- Un 1er demi-cylindre.
  graphview:addHalfCyl(
    M(0, -h/2, 1.5), r,
    M(0, h/2, 1.5), vecK,
    {color = "orange"}
  ),
-- Un 2nd demi-cylindre.
  graphview:addHalfCyl(
    M(0, 0, -5), 1,
    M(0, 0, -1), -vecI - vecJ,
    {color = "SteelBlue"}
  )
)

------
-- Montrons le résultat de notre oeuvre.
------
graphview:Show()
\end{luadraw}

\end{document}
