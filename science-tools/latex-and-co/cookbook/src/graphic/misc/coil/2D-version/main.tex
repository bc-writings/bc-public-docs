% !TEX TS-program = lualatex

%%%
% src::
%     url = https://tex.stackexchange.com/a/750922/6880
%%%

\documentclass[varwidth]{standalone}

%%%
% Des couleurs faciles d'emploi via le package ''xcolor''!
%%%
\usepackage[svgnames]{xcolor}

%%%
% La bibliothèque ''luadraw'' allie une facilité d’utilisation
% à un rendu particulièrement soigné.
%%%
\usepackage{luadraw}

\begin{document}

\begin{luadraw}{name = 2D-coil}
------
-- Nos ingrédients de base.
------
local i, cabs = cpx.I, cpx.abs

local function coil_style(color)
  return "draw = white, double = " .. color
      .. ", thin, double distance = .8pt"
end

------
-- prototype::
--     A            : départ des spirales.
--     B            : arrivée des spirales.
--     r            : "rayon" d'une boucle
--     n            : nombre de spirales.
--     draw_options : options graphiques destinées à ¨tikz.
--
--     :action: tracé d'une bobine.
------
function graph:Dcoil(A, B, r, n, draw_options)
  local a, u = A, (B - A) / (2*n + 4)
  local v    = -r*i*u / cabs(u)

------
-- La suite du code utilise la méthode ¨2D ''Dpath'' qui, comme
-- ''path'', utilise un langage dédié aux tracés de lignes
-- polygonales.
-- Ici, nous définissons une courbe de Bézier dont les points
-- de contrôle en coordonnées complexes sont ''a'', ''a'',
-- ''a + v'' et ''a + 2*u + v''.
--
--
-- note::
--     Le ¨1er point et son point de contrôle sont identiques
--     afin d'avoir une ¨1ere tangente portée par le segment
--     d'extrémités le ¨1er point et le ¨2e point de contrôle.
--     Ici, ceci permet d'avoir une tangente perpendiculaire
--     au segment reliant le départ et l'arrivée des spirales,
--     car ''v'' et ''B - A'' sont orthogonaux.
------
  local front = {a, a, a + v, a + 2*u + v, "b"}
  local back  = {}

-- Décommenter cette ligne pour visualiser la construction.
--  self:Dpolyline( {a,a + 2*u + v},"blue")

  a = a + 2*u

  for k = 1, n do
-- Commmenter l'instruction suivante pour visualiser la
-- construction.
    insert(
      back,
      {
        a + v, "m", -- On déplace le début du nouveau tracé
                    -- avec un nouveau départ pour la courbe
                    -- de Bézier qui suit.
        a + v + 3*u, a - v + 3*u, a + u - v, "b"
      })

    insert(
      front,
      {
        a + u - v, "m",
        a - v - u, a - u + v, a + v + 2*u, "b"
      })

-- Décommenter cette ligne pour visualiser la construction.
--    self:Dpolyline( {a + u - v, a + v + 2*u},"blue")

    a = a + 2*u
  end

  insert(
    front,
    {a + v + 2*u, a + 2*u, a + 2*u, "b"})

  self:Dpath(back, draw_options)
  self:Dpath(front, draw_options)

------
-- Tracé du câble fermant la spirale.
------
  local w = (r + cabs(B - A)/2) * v/r

  self:Dpath(
    {A, A - w, B - w, B, "b"},
    draw_options
  )
end

------
-- Définition de la zone graphique.
------
local graphview = graph:new{
  size = {10, 10},
  bbox = false
}

------
-- Réglage lié aux lignes.
------
graphview:Linewidth(8)

------
-- Divers usages.
------
local a, b = i, 5*i

graphview:Dcoil(
  a, b,
  .75,
  12,
  coil_style("Crimson")
)

-- Un quart de tour direct.
a, b = 2 + i*a, 2 + i*b

graphview:Dcoil(
  a, b,
  .75,
  12,
  coil_style("ForestGreen")
)

-- Sur la droite et penché.
a, b = a + 5 + 3.5*i, b + 5 - .5*i

graphview:Dcoil(
  a, b,
  1.15,
  20,
  coil_style("Goldenrod")
)

------
-- Et le merveilleux se révèle au monde.
------
graphview:Show()
\end{luadraw}

\end{document}
