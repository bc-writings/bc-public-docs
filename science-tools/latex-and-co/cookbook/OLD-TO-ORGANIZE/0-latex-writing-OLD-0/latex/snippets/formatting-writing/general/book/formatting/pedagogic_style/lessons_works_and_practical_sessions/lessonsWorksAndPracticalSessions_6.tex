% Source : http://forum.mathematex.net/latex-f6/realisation-d-un-document-type-pour-taper-ses-cours-t13221-60.html#p135864

\listfiles
\documentclass[a4paper]{book}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage[francais]{babel}
\usepackage[newparttoc]{titlesec}
\usepackage{titletoc}
\usepackage{fancyhdr}
\usepackage[margin=2.5cm]{geometry}
\usepackage{graphicx} % package important (permet de déplacer des boites, de les incliner de changer leur taille etc)
\usepackage{textcomp}
\usepackage{etoolbox}
\usepackage{multido}
\usepackage{enumitem} % package permettant de régler l'indentation dans les environnements  boiboites et barres verticales et de gérer les listes ?

% pour calculer, programmer
  \usepackage{calc,ifthen}

% pour faire des maths
  \usepackage{bbold} % permet d'écrire les ensembles
  \usepackage{mathtools,amssymb,amsfonts,latexsym}
  \usepackage{braket} % permet de faire des vecteurs
  \usepackage[b]{esvect} % permet de tracer de beaux vecteurs grâce à \vv{}
  \newcommand{\norme}[1]{\left\Vert #1\right\Vert}
  \newcommand{\diff}{\mathop{}\mathopen{}\mathrm{d}}
    \newcommand{\dtheta}{\diff \theta}
    \newcommand{\dphi}{\diff \varphi}
    \newcommand{\dr}{\diff r}
    \newcommand{\dx}{\diff x}
    \newcommand{\dy}{\diff y}
    \newcommand{\dz}{\diff z}
    \newcommand{\dt}{\diff t}

% pour dessiner
  \usepackage[dvipsnames]{xcolor}
    \colorlet{vertfonce}{black!50!green}
    \colorlet{vertfoncemoins}{black!30!green}
  \usepackage{tikz}
  \usepackage{tikz-3dplot}
  \usepackage{chemfig}

% pour souligner
  \usepackage[normalem]{ulem}
  \newcommand\reduline{\bgroup\markoverwith{\rule[-0.3ex]{2pt}{0.7pt}}\ULon}

% pour les démonstrations, théorèmes,...
  \usepackage{fourier-orns} % symbole attention \bomb
  \usepackage{framed}
  \usepackage[thmmarks,hyperref]{ntheorem}
  \usepackage{boiboites}

% pour du texte bidon
  \usepackage{lipsum}


\usepackage{makeidx}
\makeindex

\usepackage{bookmark}

\usepackage{hyperref}
%\hypersetup{ colorlinks = true, linkcolor = black, urlcolor = blue, citecolor = blue } % commande qui supprime l'encadrement des liens en rouge
\hypersetup{pdfstartview=XYZ}
\hypersetup{hyperindex=false}

% permet l'absence de chapitre avant les thèmes
\newcounter{ttl@toc@chapter}
\setcounter{ttl@toc@chapter}{0}

% permet de régler les listes
\frenchbsetup{StandardLists=true}
\setitemize[1]{label=--,partopsep=\parskip,topsep=-\parskip,itemsep=0pt,parsep=0pt,leftmargin=15pt}

% Petites capitales dans les sections
  \rmfamily
  \DeclareFontShape{T1}{lmr}{b}{sc}{<->ssub*cmr/bx/sc}{}
  \DeclareFontShape{T1}{lmr}{bx}{sc}{<->ssub*cmr/bx/sc}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DEBUT CODE PG %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter
\@addtoreset{chapter}{part}
\@addtoreset{section}{part}
\makeatother

\newcounter{savedsecnumdepth}

\newcount\subsubparttocactive
\newcount\subparttocactive
\newcount\chaptertocactive

% counter patch from ltxref.dtx
\makeatletter
\CheckCommand*\refstepcounter[1]{\stepcounter{#1}%
  \protected@edef\@currentlabel
    {\csname p@#1\endcsname\csname the#1\endcsname}%
}
\def\refstepcounter#1{\stepcounter{#1}%
  \protected@edef\@currentlabel
    {\csname p@#1\expandafter\endcsname\csname the#1\endcsname}%
}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%% EN-TETES et PIEDS DE PAGES %%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\pagestyle{fancy}
\fancyhf{} % efface tout ce qu'il y avait avant
\fancyhead[RO]{\nouppercase\rightmark} % RO = droite/impair
\fancyhead[LE]{\nouppercase\leftmark} % LE = gauche/pair
\fancyfoot[C]{\thepage}% C = centré
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

\makeatletter
\AtBeginDocument{
\newcommand{\subpartmark}[1]{\markboth{#1}{}}
\renewcommand{\subsubpartmark}[1]{\markboth{#1}{}}
\renewcommand{\chaptermark}[1]{%
   \markright {\MakeUppercase{%
      \ifnum \c@secnumdepth >\m@ne
        \if@mainmatter
          \@chapapp\space\thechapter.\ % changed "\ " to "\space" for "DS \no 1"
        \fi
      \fi
      #1}}}%

\renewcommand{\sectionmark}[1]{%
%      \markright{\MakeUppercase{%
%        \ifnum \c@secnumdepth >\z@
%          \thesection\ %
%        \fi
%        #1}}
}
}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PARTS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\frenchbsetup{PartNameFull=false}

\titleclass{\part}{page}
\titleformat{\part}[display]
  {\centering\normalfont\huge\bfseries}
  {\normalfont\bfseries\partname\ \thepart}
  {20pt}
  {\Huge}
  [\alwaysafterpart\afterpart]

\newcommand{\alwaysafterpart}{%
  \capturesubpartname{}%
%  \capturesubsubpartname{}%
  \renewcommand{\formatlsubpart}{\textbf}%
  \ifnum\subsubparttocactive=1 \stopcontents[subsubpart]\fi
  \global\subsubparttocactive=0 %
  \ifnum\subparttocactive=1 \stopcontents[subsubpart]\fi
  \global\subparttocactive=0 %
  \ifnum\chaptertocactive=1 \stopcontents[chapter]\fi
  \global\chaptertocactive=0 %
}
\newcommand{\afterpart}{}%
\newif\iffirsttocentry
\makeatletter
\newcommand{\partminitoc}{%
  \vspace{1cm}%
  \normalsize\normalfont
  \startcontents[part]
  \begin{flushleft}\bfseries\large
  Sommaire
  \end{flushleft}
  \titlerule[1pt]
  \medskip
  \renewcommand*{\l@chapter}[2]{%
    \ifnum \c@tocdepth >\m@ne
      \addpenalty{-\@highpenalty}%
      \vskip 2pt \@plus\p@
      \setlength\@tempdima{1.5em}%
      \begingroup
        \parindent \z@ \rightskip \@pnumwidth
        \parfillskip -\@pnumwidth
        \leavevmode \normalfont
        \advance\leftskip\@tempdima
        \hskip -\leftskip
        ##1\nobreak\hfil \nobreak\hb@xt@\@pnumwidth{\hss ##2}\par
        \penalty\@highpenalty
      \endgroup
    \fi}
  \firsttocentrytrue
  \DeclareRobustCommand{\twopartref}[2]{##2}% for partial ref in toc
  \printcontents[part]{part-}{0}{\setcounter{tocdepth}{0}\vskip1sp}%
  \firsttocentryfalse
  \medskip
  \titlerule[1pt]
  \bigskip
}%
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SUBPARTS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \l@subpart utilisé pour \sommaire, \tableofcontents et \partminitoc
% L'espace au-dessus de \l@subpart sur les \partminitoc est ajusté par le booléen \iffirsttocentry pour que, s'il est en premier, il ne soit pas trop important.

\newcommand{\thesubpartname}{}
\newcommand{\capturesubpartname}[1]{\gdef\thesubpartname{#1}}

\newcounter{subpart}[part]
\makeatletter
\newcommand{\ptc@minimum}[2]{%
% #1 = an integer
% #2 = an integer
% result = minimum of #1 and #2
  \the\numexpr\ifnum#1<#2 %
    #1%
  \else
    #2%
  \fi\relax
}
% @setpartialtocdepth utilisé pour le formattage conditionnel des minitoc des sous-parties ; est écrit par \addpartialtocdepth dans le fichier .aux
\newcommand{\@setpartialtocdepth}[3]{%
% #1 = section level
% #2 = unique ID (e.g. "partnb.subpartnb.subsubpartnb")
% #3 = tocdepth level
% result = defines a \ptd@#1@#2 macro which is the minimum of all the #3
  \ifcsname ptd@#1@#2\endcsname
    \expandafter\xdef\csname ptd@#1@#2\endcsname{\ptc@minimum{\csname ptd@#1@#2\endcsname}{#3}}%
  \else
    \expandafter\gdef\csname ptd@#1@#2\endcsname{#3}%
  \fi
}
% \addpartialtocdepth écrit un \@setpartialtocdepth dans le fichier .aux
\newcommand{\addpartialtocdepth}[3]{%
% #1 = section level
% #2 = unique ID (e.g. "partnb.subpartnb.subsubpartnb")
% #3 = tocdepth level
% result = writes \@setpartialtocdepth{#1}{#2}{#3} to aux file
    \protected@write{\@auxout}{}
      {\string\@setpartialtocdepth{#1}{#2}{#3}}%
}
\@addtoreset{chapter}{subpart}
\newcommand{\subpart}[1]{%
   \ifnum\subparttocactive=1 \stopcontents[subsubpart]\else\fi
   \global\subparttocactive=0 %
   \cleardoublepage
   \startcontents[subpart]%
   \thispagestyle{plain}%
   \subpartmark{#1}%
   \vspace*{0pt plus 1fill}%
   \capturesubpartname{#1}%
   \begin{center}\refstepcounter{subpart}\bfseries\huge #1\end{center}%
   \addcontentsline{toc}{subpart}{#1}%
   \vspace*{1cm}%
   \begingroup
   \ifx\partcours\currentpart % minitoc seulement si \cours est actif
   \renewcommand*{\l@subpart}[2]{}%
   \renewcommand*{\l@subsubpart}[2]{%
     \ifnum \c@tocdepth >\m@ne
       \addpenalty{-\@highpenalty}%
       \iffirsttocentry
         \firsttocentryfalse
       \else
         \vskip 1.0em plus 1pt
       \fi
         \firsttocentryfalse
       \setlength\@tempdima{1.5em}%
       \begingroup
         \parindent \z@ \rightskip \@pnumwidth
         \parfillskip -\@pnumwidth
         \leavevmode
         \advance\leftskip\@tempdima
         \hskip -\leftskip
         {\centering\bfseries\subsubpartname~##1\par}%
         \penalty\@highpenalty
         \vskip 0.25em plus 1pt %<--- changer l'espacement après ici
       \endgroup
     \fi}
   \renewcommand*{\l@chapter}[2]{%
     \ifnum \c@tocdepth >\m@ne
       \addpenalty{-\@highpenalty}%
       \vskip 2pt \@plus\p@
       \setlength\@tempdima{1.5em}%
       \begingroup
         \parindent \z@ \rightskip \@pnumwidth
         \parfillskip -\@pnumwidth
         \leavevmode \normalfont
         \advance\leftskip\@tempdima
         \hskip -\leftskip
         ##1\nobreak\hfil \nobreak\hb@xt@\@pnumwidth{\hss ##2}\par
         \penalty\@highpenalty
       \endgroup
     \fi
     \firsttocentryfalse}%
   \begin{flushleft}\bfseries\large
   Sommaire
   \end{flushleft}
   \hrule height 1pt
   \medskip
   \firsttocentrytrue
   % formattage conditionnel de la minitoc
   \ifcsname ptd@subpart@\the\c@part.\the\c@subpart\endcsname
     \edef\ptd@the@toc@depth{\csname ptd@subpart@\the\c@part.\the\c@subpart\endcsname}%
     \ifnum\ptd@the@toc@depth=0 % teste si une subsubpart est présente
                                % pour changer la présentation et ne pas
                                % afficher les l@chapter
       \renewcommand*{\l@subsubpart}[2]{% l@subsubpart = l@chapter normal
         \ifnum \c@tocdepth >\m@ne
           \addpenalty{-\@highpenalty}%
           \vskip 2pt \@plus\p@
           \setlength\@tempdima{1.5em}%
           \begingroup
             \parindent \z@ \rightskip \@pnumwidth
             \parfillskip -\@pnumwidth
             \leavevmode \normalfont
             \advance\leftskip\@tempdima
             \hskip -\leftskip
             \subsubpartname~##1\nobreak\hfil \nobreak\hb@xt@\@pnumwidth{\hss ##2}\par
             \penalty\@highpenalty
           \endgroup
         \fi
      \firsttocentryfalse}%
      \renewcommand{\l@chapter}[2]{}% ne pas afficher les chapitres
     \else
       % si aucune subsubpart, ne rien faire : afficher les chapitres
     \fi
   \fi
   \printcontents[subpart]{}{0}{\setcounter{tocdepth}{0}}%
   \firsttocentryfalse
   \medskip
   \hrule height 1pt
   \bigskip
   \fi
   \endgroup
   \vspace*{0pt plus 2fill}%
   \cleardoublepage
}
\newcommand*{\l@subpart}[2]{%
  \ifnum \c@tocdepth >\m@ne
    \addpenalty{-\@highpenalty}%
    \iffirsttocentry
      \firsttocentryfalse
    \else
      \vskip 1.0em plus 1pt
    \fi
      \firsttocentryfalse
    \setlength\@tempdima{1.5em}%
    \begingroup
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leavevmode
      \advance\leftskip\@tempdima
      \hskip -\leftskip
      \formatlsubpart{#1}\par
      \penalty\@highpenalty
      \vskip 0.25em plus 1pt %<--- changer l'espacement après ici
    \endgroup
  \fi}
\newcommand{\formatlsubpart}[1]{\centering\bfseries#1}
\makeatother

\newcommand{\thesubsubpartname}{}
\newcommand{\capturesubsubpartname}[1]{\gdef\thesubsubpartname{#1}#1}

\newcounter{subsubpart}[part]
\makeatletter
\@addtoreset{subsubpart}{subpart}% remise à zéro des subsubpart à chaque \part
\@addtoreset{chapter}{subsubpart}% remise à zéro des chapitres à chaque \subsubpart
\makeatother
\renewcommand{\thesubsubpart}{\Roman{subsubpart}}
\newcommand{\subsubpartname}{Th\`eme}
\titleclass{\subsubpart}{top}[\part]
\titleformat{\subsubpart}[display]
  {\Huge}
  {\LARGE\bfseries\subsubpartname\space\Roman{subsubpart}}
  {6pt}
  {\bfseries\capturesubsubpartname}
  [\normalsize\normalfont\aftersubsubpart]
\makeatletter
\newcommand{\aftersubsubpart}{%
%  \markboth{}{}%
  \global\subsubparttocactive=1 %
  \stopcontents[chapter]
  \startcontents[subsubpart]
  \begin{flushleft}\bfseries\large
  Sommaire
  \end{flushleft}
  \titlerule[1pt]%
  \medskip
  \addpartialtocdepth{subpart}{\the\c@part.\the\c@subpart}{0}%
  \begingroup
  \renewcommand*\l@chapter{\@dottedtocline{0}{1.5em}{2.3em}}%
  \renewcommand*\l@subpart[2]{}%
  \printcontents[subsubpart]{}{1}{\setcounter{tocdepth}{0}}%
  \endgroup
  \medskip
  \titlerule[1pt]
  \bigskip
}
\let\original@subsubpart\subsubpart
\renewcommand{\subsubpart}{%
  \@ifstar{\subsubpart@star}{\subsubpart@nostar}%
}
\newcommand{\subsubpart@star}[1]{%
  \cleardoublepage
  \refstepcounter{subsubpart}
  \addcontentsline{toc}{subsubpart}{#1}%
  \subsubpartmark{#1}%
  \original@subsubpart*{#1}%
}
\newcommand{\subsubpart@nostar}{\original@subsubpart}
\makeatother

\titlespacing*{\subsubpart}
  {0pt}
  {3pc}
  {3pc}
\titlecontents{subsubpart}
  [0em]
  {\addvspace{1pc}\centering\bfseries\large}
  {\subsubpartname\hspace*{0.01em}
     \thecontentslabel\hspace*{0.35em}--\hspace*{0.35em}}
  {}
  {}
  [\addvspace{2pt}]

\DeclareRobustCommand{\redefinetableofcontentspart}{%
  \renewcommand\formattableofcontentspart{\centering\bfseries\LARGE}%
  \renewcommand\nbpagestableofcontentspart{}%
  \renewcommand{\aftervspacetableofcontentspart}{2pc}%
}
\DeclareRobustCommand{\restoretableofcontentspart}{%
  \renewcommand\formattableofcontentspart{\bfseries\large}%
  \renewcommand\nbpagestableofcontentspart{\titlerule*[0.75em]{.}\contentspage}%
  \renewcommand{\aftervspacetableofcontentspart}{0pc}%
}

\newcommand{\formattableofcontentspart}{\bfseries\large}%
\newcommand{\nbpagestableofcontentspart}{\titlerule*[0.75em]{.}\contentspage}%
\newcommand{\aftervspacetableofcontentspart}{0pc}%

\newcommand{\beforevspacetableofcontentspart}{3pc}

\newif\ifjustafterlpart % booléen pour empêcher les coupures dans la toc
\titlecontents{part}
  [0em]
  {\addvspace{\beforevspacetableofcontentspart}\global\justafterlparttrue\formattableofcontentspart}
  {\partname\hspace*{0.01em}
     \thecontentslabel\hspace*{0.35em}--\hspace*{0.35em}}
  {}
  {\nbpagestableofcontentspart}
  [\addvspace{\aftervspacetableofcontentspart}]

\DeclareRobustCommand{\redefinesommairepart}{%
  \renewcommand\alignsommairepart{}%
  \renewcommand\beforevspacesommairepart{2em}%
  \renewcommand{\nbpagesommairepart}{\titlerule*[0.75em]{.}\contentspage}%
  \renewcommand{\aftervspacesommairepart}{0em}
}

\newcommand{\alignsommairepart}{\centering}
\newcommand{\beforevspacesommairepart}{3em}
\newcommand{\aftervspacesommairepart}{0.66em}
\newcommand{\nbpagesommairepart}{}
\titlecontents{sommaire-part}
  [0em]
  {\addvspace{\beforevspacesommairepart}\alignsommairepart\bfseries\large}
  {\partname\hspace*{0.01em}
     \thecontentslabel\hspace*{0.35em}--\hspace*{0.35em}}
  {}
  {\nbpagesommairepart}
  [\addvspace{\aftervspacesommairepart}]

\titlecontents{sommaire-subsubpart}
  [0em]
  {\addvspace{0.75em}\bfseries}
  {\subsubpartname\hspace*{0.01em}
     \thecontentslabel\hspace*{0.35em}--\hspace*{0.35em}}
  {}
  {}
  [\addvspace{2pt}]

\titlecontents{part-subsubpart}
  [0em]
  {\addvspace{0em}\centering\bfseries}
  {\subsubpartname\hspace*{0.01em}
     \thecontentslabel\hspace*{0.35em}--\hspace*{0.35em}}
  {}
  {}
  [\addvspace{2pt}]

\newcommand{\afterchapter}{}%
\makeatletter
\newsavebox{\chapterminitoc@box}
\newcommand{\chapterminitoc}{%
  \vspace*{12pt}
  \startcontents[chapter]
  \renewcommand*{\l@subpart}[2]{}%
  \def\numberline##1{\hbox to \@tempdima{\hss##1~}}
  \def\@dottedtocline##1##2##3##4##5{%
    % ##1 = level
    % ##2 = indent
    % ##3 = numwidth
    % ##4 = title
    % ##5 = page
    \ifnum ##1>\c@tocdepth \else
      \vskip \z@ \@plus.2\p@
      {\leftskip ##2\relax \rightskip \@tocrmarg \parfillskip -\rightskip
       \hskip ##2 % <--- rajout nécessaire
       \parindent ##2\relax\@afterindenttrue
       \interlinepenalty\@M
       \leavevmode
       \@tempdima=##3\relax
       \advance\leftskip \@tempdima \null\nobreak\hskip -\leftskip
       {##4}\nobreak
       \leaders\hbox{$\m@th
          \mkern \@dotsep mu\hbox{.}\mkern \@dotsep
          mu$}\hfill
       \nobreak
       \hb@xt@\@pnumwidth{\hfil\normalfont \normalcolor ##5}%
       \par}%
    \fi}
  \renewcommand*{\l@section}{\@dottedtocline{1}{0.0em}{2.5em}}
  \renewcommand*{\l@subsection}{\@dottedtocline{2}{2.5em}{2.5em}}
  \renewcommand*{\l@subsubsection}{\@dottedtocline{3}{5em}{2em}}
  \renewcommand*{\l@paragraph}{\@dottedtocline{4}{7em}{1.5em}}
  \renewcommand*{\l@subparagraph}{\@dottedtocline{5}{8.9em}{1.5em}}
  \renewcommand*{\l@subsubparagraph}{\@dottedtocline{6}{10.8em}{2em}}
  \renewcommand*{\l@subsubsubparagraph}{\@dottedtocline{7}{12.0em}{2.5em}}
  \DeclareRobustCommand{\twopartref}[2]{##2}% for partial ref in toc
  \sbox{\chapterminitoc@box}{\begin{minipage}{\textwidth}\printcontents[chapter]{}{2}{\setcounter{tocdepth}{7}}\end{minipage}}
  \ifdim\ht\chapterminitoc@box<3pt
    % sommaire vide
  \else
    % sommaire non vide
    \begin{flushleft}\bfseries\large
    Sommaire
    \end{flushleft}
    \titlerule[1pt]
    \medskip
    \printcontents[chapter]{}{2}{\setcounter{tocdepth}{7}}
    \nobreak
    \medskip
    \titlerule[1pt]
  \fi
  \bigskip
}%
\makeatother

\newsavebox{\chaptertitlebox}

\newlength{\supchaptertitlesep}
\setlength{\supchaptertitlesep}{12pt}
\newlength{\supchapterthemesep}
\setlength{\supchapterthemesep}{3pt}
\newcommand{\supchaptertitleprefix}{}%
\newcommand{\supchaptertitlefont}{}%

\titleformat{\chapter}[frame]
            {\normalfont}
            {\footnotesize\enspace\bfseries
             \savebox{\chaptertitlebox}{\chaptername\space\thechapter}%
             \vbox to \ht\chaptertitlebox{\vss
               \ifnum\value{subpart}=0 \else
                 \hbox to \wd\chaptertitlebox{\hss
                   \ifcat$\detokenize\expandafter{\thesubpartname}$\else\thesubpartname\fi
                 \hss}%
               \fi
               \ifnum\value{subsubpart}=0 \else
                 \vskip\supchapterthemesep
                 \hbox to \wd\chaptertitlebox{\hss
                   \supchaptertitlefont\supchaptertitleprefix\thesubsubpartname
                 \hss}
               \fi
               \vskip\supchaptertitlesep
               \hbox{\usebox{\chaptertitlebox}}}%
             \enspace}
            {6pt}
            {\LARGE\bfseries\filcenter}
            [\normalfont\afterchapter]
\titlespacing*{\chapter}
              {0pc}% espace à gauche
              {*4}
              {*2.3}
              [0pc]% espace à droite
%\titlecontents{chapter}%
%  [1.5em]% retrait à gauche
%  {}% matériel avant
%commun aux entrées numérotées ou pas
%  {\chaptername~\thecontentslabel~}% avant lorsqu'il y a un numéro
%  {\hspace{-1.3em}}% avant lorsqu'il n'y a pas de numéro
%  {\titlerule*[0.75em]{.}\contentspage}% points de suspension et no page

\makeatletter
\let\original@chapter\chapter
\AtBeginDocument{\setcounter{savedsecnumdepth}{\value{secnumdepth}}}%
\renewcommand{\chapter}{%
  \global\chaptertocactive=1
  \addpartialtocdepth{subpart}{\the\c@part.\the\c@subpart}{1}%
  \@ifstar{\chapter@star}{\chapter@nostar}}
\newcommand{\chapter@star}[1]{%
   \setcounter{savedsecnumdepth}{\value{secnumdepth}}%
   \setcounter{secnumdepth}{0}%
   \setlength{\fboxrule}{1pt}%
   \original@chapter*{#1}%
   \setlength{\fboxrule}{0.4pt}%
   \addcontentsline{toc}{chapter}{#1}%
}
\newcommand{\tocchapternamesep}{--}
\newcommand{\chapter@nostar}[2][]{%
   \setcounter{secnumdepth}{\value{savedsecnumdepth}}%
   \begingroup
   \let\original@addcontentsline\addcontentsline
   \renewcommand{\addcontentsline}[3]{\original@addcontentsline{##1}{##2}{\expandafter\expandafter\expandafter\chaptername\expandafter\space\expandafter##3}}%
   
   \renewcommand{\numberline}[1]{\hbox{##1~\tocchapternamesep~\hfil}}%
   \def\ttl@idot{~\tocchapternamesep~}%
   \setlength{\fboxrule}{1pt}%
   \ifcat$\detokenize{#1}$%
     \original@chapter{#2}%
   \else
     \original@chapter[#1]{#2}%
   \fi
   \setlength{\fboxrule}{0.4pt}%
   \protected@xdef\@currentlabel{\p@chapter\thechapter}
   \endgroup\@afterheading
}
\makeatother

\newcounter{STSN}[chapter]
\makeatletter\@addtoreset{section}{STSN}\makeatother
\newcommand{\STSN}[1]{%
  \ifnum\value{STSN}=0 \else\clearpage\fi
  \refstepcounter{STSN}%
  \addcontentsline{toc}{section}{\noexpand\scshape#1}
  \addvspace{0.5cm}%
  \begin{center}\bfseries\LARGE---~#1~---\end{center}%
  \addvspace{0.5cm}%
}

\makeatletter
\let\original@textbullet\textbullet
\def\font@series@m{m}
\DeclareRobustCommand{\textbullet}{%
  \ifx\f@series\font@series@m
    \ensuremath{\vcenter{\hbox{\scalebox{0.65}{\original@textbullet}}}}%
  \else
    \ensuremath{\vcenter{\hbox{\scalebox{1.10}{\original@textbullet}}}}%
  \fi}
\makeatother

\renewcommand{\tocchapternamesep}{\textbullet}

% Numérotation grecque des sections dans le document lui même (lettres en gras)
\newcommand\nogrecdoc[1]{%
   $
   \ifcase\value{#1}\relax
   \or\alpha\or\beta\or\gamma\or\delta
   \or\varepsilon\or\zeta\or\eta\or\theta
   \or\iota\or\kappa\or\lambda
   \or\mu\or\nu\or\xi\or o%
   \or\pi\or\rho
   \or\sigma\or\tau\or\upsilon
   \or\varphi\or\chi\or\psi
    \or\omega
   \fi$}

\DeclareRobustCommand{\twopartref}[2]{#1#2}% for full reference in text but partial ref in toc (see end of document)

\renewcommand{\thesection}{\Roman{section}.}
\titleformat{\section}
  {\Large\bfseries\color{red}}
  {\Roman{section}.}
  {.2em}
  {\reduline}

\renewcommand{\thesubsection}{\twopartref{\thesection}{\Alph{subsection}\textsuperscript{o}/}}
\titleformat{\subsection}
  {\large\bfseries\color{vertfonce}}
  {\Alph{subsection}\textsuperscript{o}/}
  {.2em}
  {\reduline}

\renewcommand{\thesubsubsection}{\twopartref{\thesubsection\,}{\arabic{subsubsection}\textsuperscript{o})}}
\titleformat{\subsubsection}
  {\normalsize\bfseries\color{blue}}
  {\arabic{subsubsection}\textsuperscript{o})}
  {.2em}
  {\reduline}

\renewcommand{\theparagraph}{\twopartref{\thesubsubsection\,}{\alph{paragraph})}}
\titleformat{\paragraph}
  {\normalsize\bfseries\color{orange}}
  {\alph{paragraph})}
  {.2em}
  {\reduline}

\renewcommand{\thesubparagraph}{\twopartref{\theparagraph\,}{\nogrecdoc{subparagraph})}}
\titleformat{\subparagraph}
  {\normalsize\bfseries\mathversion{bold}\color{cyan}}
  {\nogrecdoc{subparagraph})}
  {.2em}
  {\reduline}

\setcounter{secnumdepth}{8}

% création de deux nouvelles sous-sections
\titleclass{\subsubparagraph}{straight}[\subparagraph]
\newcounter{subsubparagraph}[subparagraph]
\titleformat{\subsubparagraph}
  {\normalsize\bfseries\mathversion{bold}\color{cyan}}
  {\nogrecdoc{subparagraph}$_\arabic{subsubparagraph}$)}
  {.2em}
  {\reduline}
%\titlespacing*{\subsubparagraph}{0pt}{1.625ex plus .5ex minus .1ex}{.75ex plus .1ex}
\makeatletter
\newcommand{\l@subsubparagraph}[2]{}
\makeatother
\renewcommand{\thesubsubparagraph}{\twopartref{\thesubparagraph\,}{\nogrecdoc{subparagraph}$_\arabic{subsubparagraph}$)}}


\titleclass{\subsubsubparagraph}{straight}[\subsubparagraph]
\newcounter{subsubsubparagraph}[subsubparagraph]
\titleformat{\subsubsubparagraph}
  {\normalsize\bfseries\color{magenta}}
  {\roman{subsubsubparagraph}.}
  {.2em}
  {\reduline}
%\titlespacing*{\subsubsubparagraph}{0pt}{1.625ex plus .5ex minus .1ex}{.75ex plus .1ex}
\makeatletter
\newcommand{\l@subsubsubparagraph}[2]{}
\let\p@subsubsubparagraph\p@standard
\makeatother
\renewcommand{\thesubsubsubparagraph}{\twopartref{\thesubsubparagraph\,}{\roman{subsubsubparagraph}.}}

\titlespacing*{\subsection}{5mm}{3mm}{3mm}
\titlespacing*{\subsubsection}{10mm}{3mm}{3mm}
\titlespacing*{\paragraph}{15mm}{3mm}{3mm}
\titlespacing*{\subparagraph}{20mm}{3mm}{3mm}
\titlespacing*{\subsubparagraph}{25mm}{3mm}{3mm}
\titlespacing*{\subsubsubparagraph}{30mm}{3mm}{3mm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%% COMPATIBILITE HYPERREF %%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter
\renewcommand{\toclevel@part}{-3}
%%\renewcommand{\toclevel@subpart}{-2}% not used
%%\renewcommand{\toclevel@subsubpart}{-1}% not used
\renewcommand{\toclevel@chapter}{0}
\renewcommand{\toclevel@section}{1}
\renewcommand{\toclevel@subsection}{2}
\renewcommand{\toclevel@subsubsection}{3}
\renewcommand{\toclevel@paragraph}{4}
\renewcommand{\toclevel@subparagraph}{5}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%% THEOREMES DEFINITIONS %%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\theoremstyle{nonumberbreak}
\setlength\theorempreskipamount{11pt}%
\setlength\theorempostskipamount{0pt}%
\DeclareFixedFont{\CorpF}{T1}{pcm}{m}{n}{10pt}
\theorembodyfont{\CorpF}

\newcommand{\newbarre}[4][]{\theoremsymbol{#1}
                            \newenvironment{#2}[1][]{%
                              %\setlist*[itemize,1]{leftmargin=1.5em}%
                              \def\FrameCommand{{\color{#4}\vrule width 2pt}\hspace{5pt}}
                              \MakeFramed{\advance\hsize-\width \FrameRestore}
                              \kern-2ex
                              \ifcat$\detokenize{##1}$
                                \begin{theorem@#2}%
                              \else
                                \begin{theorem@#2}[##1]%
                              \fi\hspace{\parindent}}%
                              {\end{theorem@#2}\endMakeFramed}
                            \theoremheaderfont{\bfseries\color{#4}}
                            \newtheorem{theorem@#2}{\vrule depth 0.15cm height 0cm width 0cm#3}
                           }

% CADRES CADRES CADRES CADRES CADRES CADRES CADRES CADRES CADRES CADRES
\newboxedtheorem[boxcolor=vertfonce,titlebackground=vertfoncemoins!80,titleboxcolor=black]{defi}{D\'efinition}{}
\newboxedtheorem[boxcolor=red,titlebackground=red,titleboxcolor=black]{theo}{Th\'eor\`eme}{}
\newboxedtheorem[boxcolor=orange,titlebackground=orange,titleboxcolor=black]{propo}{Proposition}{}
\newboxedtheorem[boxcolor=blue,titlebackground=blue!70,titleboxcolor=black]{notation}{Notation}{}

\newboxedtheorembis[boxcolor=red,titlebackground=red,titleboxcolor=black]{sansnom}{}{}

% BARRE VERTICALE BARRE VERTICALE BARRE VERTICALE BARRE VERTICALE
\DeclareRobustCommand{\PutOnBaseline}[2][\depth]{\raisebox{#1}{#2}} % commande permettant de mettre symbole bomb au bon niveau

\newbarre[\color{blue}$\blacksquare$]{dem}{D\'emonstration}{blue}
\newbarre{ex}{Exemple}{Fuchsia}
\newbarre{exs}{Exemples}{Fuchsia}
\newbarre{att}{\PutOnBaseline{\bomb}\ Attention !}{red}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%% NOUVELLES COMMANDES MATHS %%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter
\newcommand{\DeclareMathMacro}[2]{%
  \expandafter\let\csname original@\expandafter\@gobble\string#1\endcsname=#1
  \expandafter\def\csname\expandafter\@gobble\string#1\endcsname{\relax\ifmmode#2\else\csname original@\expandafter\@gobble\string#1\expandafter\endcsname\fi}
}
\makeatother

% ensembles standard
\DeclareMathMacro{\N}{\text{\textbb{N}}\xspace}
\DeclareMathMacro{\Z}{\text{\textbb{Z}}\xspace}
\DeclareMathMacro{\Q}{\text{\textbb{Q}}\xspace}
\DeclareMathMacro{\R}{\text{\textbb{R}}\xspace}
\DeclareMathMacro{\C}{\text{\textbb{C}}\xspace}
\DeclareMathMacro{\K}{\text{\textbb{K}}\xspace}

% nombres e et i
\DeclareMathMacro{\e}{\mathrm{e}} % e tel que ln(e)=1
\DeclareMathMacro{\i}{\mathrm{i}} % i tel que i^2=-1

\DeclareMathMacro{\th}{\operatorname{th}}
%\DeclareMathMacro{\coth}{\operatorname{coth}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%% CONFIGURATION INTEGRALES %%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \int pour regarde s'il est suivi de \int, si oui il met automatiquement une espace négative (\!\!).
% programmation de pg

\makeatletter
\let\original@int\int
\DeclareRobustCommand{\int}{%
   \original@int\operator@followup{\@ifnextchar{\int}{\!\!}{}}%
}
\def\operator@followup#1{%
   \@ifnextchar{^}{\operator@followup@sup{#1}}%
                  {\operator@followup@nosup{#1}}%
}
\def\operator@followup@sup#1^#2{%
   \@ifnextchar{_}{\operator@followup@sup@sub{#1}^{#2}}%
                  {\operator@followup@sup@nosub{#1}^{#2}}%
}
\def\operator@followup@sup@sub#1^#2_#3{%
   \operator@followup@{#1}{#2}{#3}%
}
\def\operator@followup@sup@nosub#1^#2{%
   \operator@followup@{#1}{#2}{}%
}
\def\operator@followup@nosup#1{%
   \@ifnextchar{_}{\operator@followup@nosup@sub{#1}}
                  {\operator@followup@nosup@nosub{#1}}%
}
\def\operator@followup@nosup@sub#1_#2{%
   \@ifnextchar{^}{\operator@followup@nosup@sub@sup{#1}_{#2}}
                  {\operator@followup@nosup@sub@nosup{#1}_{#2}}%
}
\def\operator@followup@nosup@sub@sup#1_#2^#3{%
   \operator@followup@{#1}{#3}{#2}%
}
\def\operator@followup@nosup@sub@nosup#1_#2{%
   \operator@followup@{#1}{}{#2}%
}
\def\operator@followup@nosup@nosub#1{%
   \operator@followup@{#1}{}{}%
}
\def\operator@followup@#1#2#3{%
   ^{#2}_{#3}#1%
}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%% CONFIGURATION PARTIES %%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% pour la gestion de minitoc dans \subpart seulement si \cours est actif
\newcommand{\currentpart}{}%
\newcommand{\partcours}{cours}%

\newcommand{\cours}{%
  \renewcommand{\currentpart}{cours}%
  \renewcommand{\chaptername}{Chapitre}%
  \renewcommand{\thechapter}{\arabic{chapter}}%
  \renewcommand{\subsubpartname}{Th\`eme}%
  \renewcommand{\supchaptertitleprefix}{\subsubpartname~\thesubsubpart~:~}%
  \renewcommand{\afterchapter}{\chapterminitoc}%
  \renewcommand{\afterpart}{\stopcontents[part]}%
}
\newcommand{\annexes}{%
  \renewcommand{\currentpart}{annexes}%
  \renewcommand{\chaptername}{Annexe}%
  \renewcommand{\thechapter}{\Alph{chapter}}%
  \renewcommand{\subsubpartname}{Th\`eme}%
  \renewcommand{\supchaptertitleprefix}{}%
  \renewcommand{\afterchapter}{\chapterminitoc}%
  \renewcommand{\afterpart}{\partminitoc}%
}
% pour tous les autres, \afterchapter est vide pour ne pas faire apparaître de mini table des matières
\newcommand{\devoirssurveilles}{%
  \renewcommand{\currentpart}{devoirssurveilles}%
  \renewcommand{\chaptername}{DS \no}%
  \renewcommand{\thechapter}{\arabic{chapter}}%
  \renewcommand{\subsubpartname}{Ann\'ee scolaire}%
  \renewcommand{\supchaptertitleprefix}{}%
  \renewcommand{\afterchapter}{\vspace*{2em}}%
  \renewcommand{\afterpart}{\partminitoc}%
}
\newcommand{\devoirslibres}{%
  \renewcommand{\currentpart}{devoirslibres}%
  \renewcommand{\chaptername}{DL \no}%
  \renewcommand{\thechapter}{\arabic{chapter}}%
  \renewcommand{\subsubpartname}{Ann\'ee scolaire}%
  \renewcommand{\supchaptertitleprefix}{}%
  \renewcommand{\afterchapter}{\vspace*{2em}}%
  \renewcommand{\afterpart}{\partminitoc}%
}
\newcommand{\travauxpratiques}{%
  \renewcommand{\currentpart}{travauxpratiques}%
  \renewcommand{\chaptername}{TP \no}%
  \renewcommand{\thechapter}{\arabic{chapter}}%
  \renewcommand{\subsubpartname}{Th\`eme}%
  \renewcommand{\supchaptertitleprefix}{}%
  \renewcommand{\afterchapter}{\chapterminitoc}%
  \renewcommand{\afterpart}{\partminitoc}%
}
\newcommand{\exercices}{%
  \renewcommand{\currentpart}{exercices}%
  \renewcommand{\chaptername}{Feuille d'exercices \no}%
  \renewcommand{\thechapter}{\arabic{chapter}}%
  \renewcommand{\subsubpartname}{Th\`eme}%
  \renewcommand{\supchaptertitleprefix}{}%
  \renewcommand{\afterchapter}{\vspace*{2em}}%
  \renewcommand{\afterpart}{\partminitoc}%
}
\newcommand{\colles}{%
  \renewcommand{\currentpart}{colles}%
  \renewcommand{\chaptername}{Colle \no}%
  \renewcommand{\thechapter}{\arabic{chapter}}%
  \renewcommand{\subsubpartname}{Ann\'ee scolaire}%
  \renewcommand{\supchaptertitleprefix}{}%
  \renewcommand{\afterchapter}{\vspace*{2em}}%
  \renewcommand{\afterpart}{\stopcontents[part]}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%% PAGE DE GARDE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter
\def\thickhrulefill{\leavevmode \leaders \hrule height 1pt\hfill \kern \z@}
\renewcommand{\maketitle}{\begin{titlepage}%
    \let\footnotesize\small
    \let\footnoterule\relax
    \parindent \z@
    \reset@font
    \null
    \vskip 50\p@
    \begin{center}
      \hrule height 2pt
\vskip 1pt
      {\huge \bf \bfseries \strut \sc \@title \sc \strut}\par
\vskip 1pt
      \hrule height 2pt

      \vskip 1cm
          {\Large \@author\par}%
          \vskip 1cm
          {\Large \@date\par}%
     
    \end{center}

    \vfil
        \null
  \end{titlepage}%
  \setcounter{footnote}{0}%
}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%% NOTE DE BAS DE PAGE %%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% on peut maintenant mettre des notes de bas de page dans les tableaux, les environnements définitions...

% rajoute un \refstepcounter{automasterfootnote} à toutes les {tikzpicture} et {tabular}
\preto{\tikzpicture}{\refstepcounter{automasterfootnote}}
\preto{\tabular}{\refstepcounter{automasterfootnote}}
\makeatletter
\newcounter{automasterfootnote}
\newcounter{autofootnote}[automasterfootnote]
\newcommand{\autofootnotemark}{%
  \begingroup\let\@xfootnotemark\fixed@xfootnotemark
  \refstepcounter{autofootnote}%
  \footnotemark[\the\numexpr\value{footnote}+\value{autofootnote}\relax]%
  \expandafter\global\expandafter\let
    \csname saved@Href@\the\numexpr\value{footnote}%
                                   +\value{autofootnote}\relax\endcsname
    \Hy@footnote@currentHref
  \endgroup}
\newcommand{\autofootnotetext}[1]{%
  \refstepcounter{footnote}\refstepcounter{Hfootnote}%
  \expandafter\let\expandafter\Hy@footnote@currentHref
    \csname saved@Href@\arabic{footnote}\endcsname
  \footnotetext{#1}}

% commande adaptée de hyperref.sty pour faire marcher les liens avec \footnotemark[...]
\def\fixed@xfootnotemark[#1]{%
  \begingroup
    \c@footnote #1\relax
    \unrestored@protected@xdef\@thefnmark{\thefootnote}%
  \endgroup
  \stepcounter{Hfootnote}%
  \global\let\Hy@saved@currentHref\@currentHref
  \hyper@makecurrent{Hfootnote}%
  \global\let\Hy@footnote@currentHref\@currentHref
  \global\let\@currentHref\Hy@saved@currentHref
  \hyper@linkstart{link}{\Hy@footnote@currentHref}%
  \H@@footnotemark
  \hyper@linkend
}%

\renewcommand\@makefntext[1]%
   {\noindent\makebox[1.8em][r]{\@makefnmark\,}#1}

\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DIVERS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Commande perso pour faire des listes de propositions de traduction (exemple : \liste{amis \\ drôles de zigotos})
\newcommand{\liste}[1]{\begin{tabular}[t]{|l|} #1 \end{tabular}}





\author{Professeur : }
\title{Cours et exercices \\ de  \vskip 1cm classe}
\date{Année scolaire }



\begin{document}

\maketitle

\startcontents[tableofcontents]

\makeatletter
\original@chapter*{Sommaire}
\makeatother
\addcontentsline{toc}{part}{Sommaire}
\addtocontents{ptc}{\redefinetableofcontentspart}
\startcontents[part]
\startcontents[sommaire]

\begingroup\makeatletter
\renewcommand*\l@chapter{\@dottedtocline{0}{0em}{1.5em}}
\printcontents[sommaire]{sommaire-}{-1}{\setcounter{tocdepth}{0}}
\endgroup

\cours
\part{Cours}

\chapter{test}

\section{Essai}

\[ \boxed{a=b} \]

\subsection{Essai}

\subsubsection{Essai}

\paragraph{Essai}

\begin{defi}[mécanique]\index{mecanique}
la mécanique est une science
\end{defi}

\chapter{test}

\section{Essai}\index{truc}

\subsection{Essai}

\subsubsection{Essai}

\paragraph{Essai}

\subparagraph{Essai}

\part{Titre de la partie}

\subpart{Titre de la sous-partie}

\chapter{Titre du chapitre}

Bla bla.

\chapter{Titre du chapitre}

Bla bla.

\section{Titre de la section}

\subsubpart{Titre de la sous-sous-partie}

\chapter{Titre du chapitre}

Bla bla.


\addtocontents{ptc}{\redefinesommairepart}
\addtocontents{ptc}{\restoretableofcontentspart}

\makeatletter
\let\chapter\original@chapter
\makeatother

\renewcommand{\afterchapter}{\vspace*{2em}}%

\cleardoublepage\phantomsection\addcontentsline{toc}{part}{\bibname}
\begin{thebibliography}{10}
\vspace*{1cm}
    \bibitem{1} \textsc{Nom} (Prenom), \emph{Titre}, date, editeur.
    \bibitem{2} \textsc{Nom} (Prenom), \emph{Titre}, date, editeur.
    \bibitem{3} \textsc{Nom} (Prenom), \emph{Titre}, date, editeur.
    \bibitem{4} \textsc{Nom} (Prenom), \emph{Titre}, date, editeur.
    \bibitem{5} \textsc{Nom} (Prenom), \emph{Titre}, date, editeur.
    \bibitem{6} \textsc{Nom} (Prenom), \emph{Titre}, date, editeur.
    \bibitem{7} \textsc{Nom} (Prenom), \emph{Titre}, date, editeur.
    \bibitem{8} \textsc{Nom} (Prenom), \emph{Titre}, date, editeur.
    \bibitem{9} \textsc{Nom} (Prenom), \emph{Titre}, date, editeur.
    \bibitem{10} \textsc{Nom} (Prenom), \emph{Titre}, date, editeur.
\end{thebibliography}

\cleardoublepage\phantomsection\addcontentsline{toc}{part}{\indexname}
\printindex

\stopcontents[tableofcontents]

\backmatter
\cleardoublepage\phantomsection\addcontentsline{toc}{part}{\contentsname}
\chapter*{\contentsname}
\makeatletter
\@mkboth{\MakeUppercase\contentsname}{\MakeUppercase\contentsname}
\renewcommand{\formatlsubpart}[1]{\centering\Large\bfseries#1}
\renewcommand*{\l@subpart}[2]{%
  \ifnum \c@tocdepth >\m@ne
    \ifjustafterlpart\nobreak\else
    \addpenalty{-\@highpenalty}%
    \fi
    \iffirsttocentry
      \firsttocentryfalse
    \else
      \vskip 1.0em plus 1pt
    \fi
      \firsttocentryfalse
    \setlength\@tempdima{1.5em}%
    \begingroup
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leavevmode
      \advance\leftskip\@tempdima
      \hskip -\leftskip
      \formatlsubpart{#1}\par
      \ifjustafterlpart\nobreak\else
      \penalty\@highpenalty
      \fi
      \vskip 0.25em plus 1pt %<--- changer l'espacement après ici
    \endgroup
  \fi}
\renewcommand*{\l@subsubpart}[2]{%
  \ifnum \c@tocdepth >\m@ne
    \ifjustafterlpart\nobreak\else
%    \addpenalty{-\@highpenalty}%
      \goodbreak
    \fi
    \iffirsttocentry
      \firsttocentryfalse
    \else
      \vskip 1.0em plus 1pt
    \fi
      \firsttocentryfalse
    \setlength\@tempdima{1.5em}%
    \begingroup
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leavevmode
      \advance\leftskip\@tempdima
      \hskip -\leftskip
      \renewcommand{\numberline}[1]{\subsubpartname\space
         ##1\hspace*{0.35em}--\hspace*{0.35em}}
      {\centering\bfseries\large#1\par}%
      \ifjustafterlpart\nobreak\else
      \penalty\@highpenalty
      \fi
      \vskip 0.25em plus 1pt %<--- changer l'espacement après ici
    \endgroup
  \fi}
\newlength{\lchapterrulewidth}
\newlength{\lchapterrulesep}
\renewcommand*{\l@chapter}[2]{%
  \ifnum \c@tocdepth >\m@ne
    \ifjustafterlpart\nobreak\else
    \addpenalty{-\@highpenalty}%
    \fi
    \vskip 2pt \@plus\p@
    \setlength\@tempdima{1.5em}%
    \begingroup
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leavevmode \normalfont
      \advance\leftskip\@tempdima
      \ifdim\lchapterrulewidth>0pt
        \hskip -\leftskip
        \rule{\textwidth}{\lchapterrulewidth}\par\nobreak
        \vspace*{\lchapterrulesep}%
      \fi
      \hskip -\leftskip
      \bfseries#1\nobreak\hfil\nobreak\hbox to \@pnumwidth{\hss #2}\par
      \ifjustafterlpart\else
      \penalty\@highpenalty
      \fi
    \endgroup
    \global\justafterlpartfalse
  \fi}
%\def\numberline#1{\llap{#1~}}
%\renewcommand*{\l@section}{\@dottedtocline{1}{2.0em}{0em}}
%\renewcommand*{\l@subsection}{\@dottedtocline{2}{3.8em}{0em}}
%\renewcommand*{\l@subsubsection}{\@dottedtocline{3}{5.5em}{0em}}
%\renewcommand*{\l@paragraph}{\@dottedtocline{4}{7.5em}{0em}}
%\renewcommand*{\l@subparagraph}{\@dottedtocline{5}{9.5em}{0em}}
  \def\numberline#1{\hbox to \@tempdima{\hss#1~}}
  \renewcommand*{\l@section}{\@dottedtocline{1}{0.0em}{2.5em}}
  \renewcommand*{\l@subsection}{\@dottedtocline{2}{2.5em}{2.5em}}
  \renewcommand*{\l@subsubsection}{\@dottedtocline{3}{5em}{2em}}
  \renewcommand*{\l@paragraph}{\@dottedtocline{4}{7em}{1.5em}}
  \renewcommand*{\l@subparagraph}{\@dottedtocline{5}{8.9em}{1.5em}}
  \renewcommand*{\l@subsubparagraph}{\@dottedtocline{6}{10.8em}{2em}}
  \renewcommand*{\l@subsubsubparagraph}{\@dottedtocline{7}{12.0em}{2.5em}}
\makeatother
\setlength{\lchapterrulewidth}{1.5pt}
\setlength{\lchapterrulesep}{-2pt}
\DeclareRobustCommand{\twopartref}[2]{#2}% for partial ref in toc
\printcontents[tableofcontents]{}{-1}{\setcounter{tocdepth}{7}}

\end{document}