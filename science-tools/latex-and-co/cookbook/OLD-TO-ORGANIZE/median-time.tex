% Source: https://tex.stackexchange.com/q/684848/6880

\documentclass{scrlttr2}

\ExplSyntaxOn

\NewDocumentCommand{\newtime}{m}
{
    \fp_new:c { g__timecalc_time_#1_fp }
    \fp_new:c { g__timecalc_factor_#1_fp} % factor to divide the result by after the table
}
\newtime{default} % initialize one

% \addtime* will also show the added time
\NewDocumentCommand{\addtime}{sO{default}mm}
{
    \timecalc_time_add:nnn { #2 } { #3 } { #4 }
    
    % with \addtime* also show what's been added    
    \IfBooleanT{#1}{#3\,\textup{#4}}
}

% show the result of the sum in g__timecalc_time_#1_fp with biggest unit being #2
\NewDocumentCommand{\strtime}{O{default}m}
{
    \timecalc_time_str:nn { #1 } { #2 }
}

\int_new:N \l__timecalc_time_days_int
\int_new:N \l__timecalc_time_hours_int
\int_new:N \l__timecalc_time_minutes_int

% add the given time #2 with given unit #3 to __timecalc_time_#1_fp
\cs_new_protected:Nn \timecalc_time_add:nnn
{
    \str_case:nnF { #3 }
    {
        {h}{ \fp_gadd:cn { g__timecalc_time_#1_fp } { #2 * 60 } }
        {d}{ \fp_gadd:cn { g__timecalc_time_#1_fp } { #2 * 60 * 24 } }
        {min}{ \fp_gadd:cn { g__timecalc_time_#1_fp } { #2 } }
    }
    {\ERROR}
}

% calculate #1 = #1 / #2 and return the modulo in #3
\cs_new_protected:Nn \timecalc_int_div_mod:nnn {
    \int_set:Nn #3 
    { \int_div_truncate:nn { #1 } { #2 } }
    
    \int_set:Nn #1
    { \int_mod:nn { #1 } { #2 } }
}

% round the sum in g__timecalc_time_#1_fp and show value with biggest unit being #2
\cs_new_protected:Nn \timecalc_time_str:nn
{
    % round to full minutes
    \int_set:Nn \l__timecalc_time_minutes_int
    { \fp_eval:n { round( \fp_use:c { g__timecalc_time_#1_fp }, 0 ) } }
    
    \timecalc_time_strshow:nn \l__timecalc_time_minutes_int { #2 }
}

% show the value of \l__timecalc_time_minutes_int with biggest unit being #2
\cs_new_protected:Nn \timecalc_time_strshow:nn
{
    \bool_if:nTF
    {
        \str_if_eq_p:nn{#2}{d}
    }
    {%yes
        % compute and remove the number of days
        \timecalc_int_div_mod:nnn{\l__timecalc_time_minutes_int}{1440}{\l__timecalc_time_days_int}
        
        % now print the days
        \int_compare:nTF { \l__timecalc_time_days_int > 0 }
        { \int_eval:n { \l__timecalc_time_days_int }\,\textup{d}\; }
        {
            \unkern
        }
    }{} % no
    
    \bool_if:nTF
    {
        \str_if_eq_p:nn{#2}{h} ||
        \str_if_eq_p:nn{#2}{d} 
    }
    {% yes
        % compute and remove the number of hours
        \timecalc_int_div_mod:nnn{\l__timecalc_time_minutes_int}{60}{\l__timecalc_time_hours_int}
        
        % now print the hours
        \int_compare:nTF { \l__timecalc_time_hours_int > 0 }
        {
            \int_eval:n { \l__timecalc_time_hours_int }\,\textup{h}\;
        }
        {% no hours
            \unkern
        }       
    }{} % no
    
    
    % now print the minutes
    \int_compare:nTF { \l__timecalc_time_minutes_int > 0 }
    {
        \int_eval:n { \l__timecalc_time_minutes_int }\,\textup{min}
    }
    {% no minutes
        \unkern
    }
}

% =====================
%  time list and median calculations

% show the median of the clist in #1
\NewDocumentCommand{\listmedian}{m}
{
    \timelist_median:x { #1 }
}

\clist_new:N \l__timelist_median_clist
\int_new:N \l__timelist_median_int

\cs_new_protected:Nn \timelist_median:n
{
    % set a comma separated list
    \clist_set:Nn \l__timelist_median_clist { #1 }
    % sort it numerically
    \clist_sort:Nn \l__timelist_median_clist
    {
        \fp_compare:nTF { ##1 > ##2 }
        { \sort_return_swapped: }
        { \sort_return_same: }
    }
    % compute the number of items
    \int_set:Nn \l__timelist_median_int { \clist_count:N \l__timelist_median_clist }
    \int_if_odd:nTF {\l__timelist_median_int }
    {% if the number is odd, return the middle item
        \clist_item:Nn \l__timelist_median_clist { (\l__timelist_median_int + 1)/2 }
    }
    {% otherwise the average of the middle two elements
        \fp_eval:n
        {
            ( 
            \clist_item:Nn \l__timelist_median_clist { \l__timelist_median_int/2 }
            +
            \clist_item:Nn \l__timelist_median_clist { \l__timelist_median_int/2 + 1 }
            )/2
        }
    }
}
\cs_generate_variant:Nn \timelist_median:n { x }

\clist_clear_new:N \g__timelist_median_clist

\NewDocumentCommand{\addtimelist}{sO{default}mm}
{
    \str_case:nnF { #4 }
    {
        {h}{ \clist_gput_right:Nn { \g__timelist_median_clist } { #3 * 60 } }
        {d}{ \clist_gput_right:Nn { \g__timelist_median_clist } { #3 * 60 * 24 } }
        {min}{ \clist_gput_right:Nn { \g__timelist_median_clist } { #3 } }
    }
    {
        %\ERROR
    }
    
    \IfBooleanT{#1}{#3\,\textup{#4}}    
}

\NewDocumentCommand{\timelistmedian}{O{default}}
{
    \listmedian{ \g__timelist_median_clist }
}

% should show the 
\NewDocumentCommand{\strtimelist}{O{default}m}
{
    \listmedian{ \g__timelist_median_clist }

% ========================================================
% the code from here breaks

% round to full minutes
%   \int_set:Nn \l__timecalc_time_minutes_int
%   { \fp_eval:n { round( \fp_use:x { \listmedian{ \g__timelist_median_clist } }, 0 ) } } % cannot use clist as input for median?
%
%   \int_eval:N \l__timecalc_time_minutes_int
%\timecalc_time_strshow:nn \l__timecalc_time_minutes_int { #2 }
}



\ExplSyntaxOff

\begin{document}
    addtime:
    
    \addtime*{4}{min}
    
    \addtime*{5}{h}
    
    sum = 
    
    \strtime{h}
    
    \strtime{min}
    
    \bigskip
    addtimelist:
    
    \addtimelist*{4}{min}
    
    \addtimelist*{5}{h}
    
    \timelistmedian
    
    median = \strtimelist{h}
    
\end{document}

